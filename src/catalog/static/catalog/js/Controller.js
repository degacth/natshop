// Generated by CoffeeScript 1.9.2
(function() {
  var cart_sum, print,
    slice = [].slice,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module('Catalog').controller("Product", function($scope, Carter) {
    var cart, carter;
    carter = new Carter($scope.cart);
    cart = $scope.cart;
    angular.extend($scope, {
      id: null,
      add_cart: function() {
        return new $scope.cart_model({
          id: this.id,
          count: 1
        }).$save().then(function(data) {
          carter.set(data);
          return $scope.in_cart = true;
        });
      }
    });
    return $scope.$watch(cart, function() {
      return cart.$promise.then(function() {
        return $scope.in_cart = -1 < carter.get_index($scope.id);
      });
    });
  }).controller("Cart", function($scope) {
    return angular.extend($scope, {
      sum: function() {
        return cart_sum($scope.cart);
      }
    });
  }).controller("MainProducts", function($scope) {
    return angular.extend($scope, {
      category: null,
      is_hidden: function() {
        var categories, id, ref;
        id = arguments[0], categories = 2 <= arguments.length ? slice.call(arguments, 1) : [];
        return !(ref = this.category, indexOf.call(categories, ref) >= 0);
      },
      is_active: function(id) {
        if (id === this.category) {
          return 'active';
        }
      }
    });
  }).controller("BasketBase", function($scope, $location, Order, BASKET_URL) {
    angular.extend($scope, {
      order: {
        comment: ""
      },
      make_order: function() {
        var order;
        order = new Order(this.order);
        return order.$save().then(function() {
          return $scope.cart.splice(0, $scope.cart.length);
        });
      }
    });
    $location.path(BASKET_URL);
    return $scope.$on('$locationChangeStart', function(e, nw, old) {
      if (!nw.split('#')[1]) {
        return e.preventDefault();
      }
    });
  }).controller("Basket", function($scope, Carter) {
    var carter;
    carter = new Carter($scope.cart);
    return angular.extend($scope, {
      add: function(product) {
        product.count++;
        return this.save(product);
      },
      sub: function(product) {
        if (product.count <= 1) {
          return;
        }
        product.count--;
        return this.save(product);
      },
      save: function(product) {
        return new this.cart_model(product).$save();
      },
      remove: function(product) {
        return product.$delete().then(function() {
          return carter.remove(product);
        });
      },
      sum: function() {
        return cart_sum($scope.cart);
      },
      all_count: function() {
        return _.reduce(this.cart, (function(l, n) {
          return l + n.count;
        }), 0);
      }
    });
  });

  print = console.log.bind(console);

  cart_sum = function(cart) {
    return _.reduce(_.map(cart, function(c) {
      return c.price * c.count;
    }), (function(l, n) {
      return l + n;
    }), 0);
  };

}).call(this);
